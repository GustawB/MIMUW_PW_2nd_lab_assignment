#!/bin/bash
set -e

# prepare exported solution
make assignment.zip

# reset public_repo folder to known state (specified by template hash)
if [ -e "public_repo" ] ; then
    cd public_repo
    git fetch
    git clean -fd
    git reset --hard `cat ../template_hash`
else
    git clone https://github.com/baktrius/MIMUW_PW_2nd_lab_assignment public_repo
    cd public_repo
    git checkout `cat ../template_hash`
fi

# extract solution
unzip ../assignment.zip -d assignment

# populate public_repo with files from assignment.zip which are allowd for change
cd assignment
for file in `cat ../files_allowed_for_change`
do
    cp "$file" "../$file"
done
cd ..

# build solution and run tests
./test
cd ..
# rm -rf public_repo
